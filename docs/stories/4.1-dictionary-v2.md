# Epic 4 — Dictionary v2

## Status
Ready for Review

## Story
**As a** user,  
**I want** a Dictionary where I can add and manage correction rules,  
**so that** CrocoVoice consistently fixes recurring terms in my transcriptions.

## Acceptance Criteria
1. I can add a dictionary entry from the dashboard (term + correction) and it is persisted locally.
2. I can delete a dictionary entry from the dashboard and it is removed immediately.
3. Dictionary corrections are applied in the dictation pipeline consistently (same behavior for widget and dashboard flows).
4. Each entry stores usage metadata: `frequency_used`, `last_used`, `source`, and `auto_learned` (default: manual, false).
5. Matching rules are explicit and predictable (v1 recommendation):
   - Case-insensitive matching.
   - Whole-word matching by default (avoid surprising replacements inside other words).
   - When multiple terms match, apply the **most specific** (longest term) first; do not re-replace inside already replaced segments.
6. Dictionary works offline (SQLite source of truth); if sync is enabled, upserts/deletes are queued and non-blocking.
7. Empty states and errors are user-friendly (no silent failures).

## Tasks / Subtasks
- [x] Confirm dictionary UI supports add + delete with clear validation (AC: 1,2,7)
- [x] Update dictionary schema to include usage metadata (AC: 4)
- [x] Track usage on apply (increment count, set last_used/source/auto_learned) (AC: 4)
- [x] Define and implement matching rules and conflict resolution (AC: 5)
- [x] Ensure dictionary is applied in the main pipeline for all dictation entry points (AC: 3)
- [x] Ensure offline-first behavior and non-blocking sync (AC: 6)

## Dev Notes
- Storage: `store.js` dictionary table (`listDictionary`, `upsertDictionary`, `deleteDictionary`).
- Metadata defaults: `frequency_used = 0`, `last_used = null`, `source = manual`, `auto_learned = 0`.
- Pipeline: `main.js` has a “record → transcribe → post-process → dictionary → persist → type” flow; dictionary application should live in the main process.
- UI: `dashboard.html` / `dashboard.js` Dictionary view; keep patterns consistent with Notes/History.
- UX recommendation for clarity:
  - Show “From → To” rows and allow quick delete.
  - Add lightweight validation: non-empty term, prevent exact duplicates, and show a small example preview (“This will change …”).

### Testing
- Manual: add entries, verify text transforms, delete entries, verify transforms stop applying, restart persistence.
- Edge cases: overlapping entries, casing, accents, punctuation boundaries.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-20 | v0.1 | Story created from global PRD Epic 4 shard plan | PO |

## Dev Agent Record
### Agent Model Used
GPT-5

### Debug Log References
N/A

### Completion Notes List
- Ajout des champs d'usage du dictionnaire + mise à jour lors de l'application.
- Règles de matching v2 (insensible à la casse, mot entier, plus spécifique, sans re-remplacement).
- Validation UI côté dashboard (anti-duplicats) et sync non bloquant.

### File List
- main.js
- store.js
- dashboard.js
- sync.js
- test-core.js

## QA Results

# Story 1.3: fix-sync-integrity-and-user-scoping

## Status
Approved

## Story
**As a** user,
**I want** sync to be reliable and user-scoped,
**so that** my data is consistent and protected.

**Epic alignment:** Supports Epic 1 goal to secure and stabilize the codebase.
**Dependencies:** None.

## Acceptance Criteria
1. Remote purge operations are scoped by user_id as defense in depth.
2. Sync uses pagination for pull operations to avoid missing rows.
3. Sync cursor is based on server timestamps or max updated_at seen, not local clock.
4. Delete propagation is supported (tombstones or reconciliation) for offline deletes.

## Tasks / Subtasks
- [ ] Task 1: Scope remote purge to authenticated user (AC: 1)
  - [ ] Update `sync.js` purge path to include `user_id` filter for remote deletes
  - [ ] Ensure local-first behavior is unchanged and sync remains optional/non-blocking
  - Ref: `docs/architecture/architecture.md#Integration Approach`, `docs/architecture/architecture.md#Compatibility Requirements`
- [ ] Task 2: Add pagination for sync pull operations (AC: 2)
  - [ ] Update sync pull queries in `sync.js` to page through results safely (use existing client pagination mechanisms; no schema changes)
  - [ ] Ensure behavior preserves existing data and does not block core flow
  - Ref: `docs/architecture/architecture.md#Integration Approach`, `docs/architecture/architecture.md#Compatibility Requirements`
- [ ] Task 3: Update cursor strategy to avoid local clock skew (AC: 3)
  - [ ] Use server timestamps or max observed `updated_at` from pull results for next cursor
  - [ ] Persist cursor in existing settings without schema changes
  - Ref: `docs/architecture/architecture.md#Compatibility Requirements`, `docs/architecture/architecture.md#Integration Approach`
- [ ] Task 4: Add delete propagation strategy (AC: 4)
  - [ ] Implement reconciliation-only delete propagation (no new tables/columns) consistent with compatibility constraints
  - [ ] Keep local SQLite as source of truth; sync remains best-effort
  - Ref: `docs/architecture/architecture.md#Compatibility Requirements`, `docs/architecture/architecture.md#Integration Approach`
- [ ] Task 5: Manual verification (AC: 1â€“4)
  - [ ] Validate sync correctness with multi-record datasets and deletes
  - [ ] Validate no regression in local-first behavior
  - Ref: `docs/architecture/architecture.md#Testing Strategy`

## Dev Notes

**Relevant Source Tree**
- Core files live at repo root; sync logic is in `sync.js`.
  [Source: `docs/architecture/architecture.md#Source Tree`]

**Existing Patterns / Constraints**
- Keep SQLite as local source of truth; cloud sync is optional and must be non-blocking.
  [Source: `docs/architecture/architecture.md#Integration Approach`]
- Preserve IPC and UI behavior; changes are internal to sync service.
  [Source: `docs/architecture/architecture.md#Compatibility Requirements`]
- No destructive schema changes to local SQLite.
  [Source: `docs/architecture/architecture.md#Compatibility Requirements`]

**Data/Schema Guidance**
- No new tables or schema changes are defined in architecture; changes should be additive and use existing settings storage for cursor state.
  [Source: `docs/architecture/architecture.md#Data Models and Schema Changes`]
**Implementation Note**
- No specific guidance found in architecture docs for pagination or delete propagation mechanics; select approaches that avoid schema changes and preserve non-blocking sync.
  [Source: `docs/architecture/architecture.md#Compatibility Requirements`]

### Testing
- No automated test harness exists; manual testing and runtime logs are expected.
  [Source: `docs/architecture/architecture.md#Testing Strategy`]

Manual verification to document:
- Sync pulls are complete with large datasets (pagination works across multiple pages).
- Cursor advances based on server timestamps/max updated_at, not local clock.
- Deletes reconcile correctly without local data loss (offline delete -> sync -> remote reflects deletion).
- Local-first behavior remains unchanged.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-24 | v0.1 | Draft story created from Epic 1 | Bob |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results

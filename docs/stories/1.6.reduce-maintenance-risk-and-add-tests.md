# Story 1.6: reduce-maintenance-risk-and-add-tests

## Status
Approved

## Story
**As a** developer,
**I want** the core logic modularized and covered by tests,
**so that** regressions are less likely and changes are safer.

**Epic alignment:** Supports Epic 1 goal to secure and stabilize the codebase.
**Dependencies:** None.

## Acceptance Criteria
1. main.js responsibilities are split into focused internal sections/functions without changing runtime behavior (no new folders/files required).
2. Shared utilities are de-duplicated (word count, subscription logic, retention logic).
3. A minimal unit-test approach exists for recording state transitions, quota logic, dictionary application, and sync cursor logic, using existing project conventions (no new folders required).
4. Preload IPC listeners provide cleanup mechanisms to avoid duplicate handlers.

## Tasks / Subtasks
- [ ] Task 1: Modularize main process logic without behavior changes (AC: 1)
  - [ ] Refactor `main.js` into clear, focused sections/functions (recording state, transcription pipeline, sync scheduling, tray/shortcuts) while preserving current IPC and UX
  - [ ] Keep flat root structure; avoid new folders/files
  - Ref: `docs/architecture/architecture.md#Integration Approach`, `docs/architecture/architecture.md#Source Tree`, `docs/architecture/architecture.md#Compatibility Requirements`
- [ ] Task 2: De-duplicate shared utilities across core files (AC: 2)
  - [ ] Consolidate duplicate helpers (word count, subscription logic, retention logic) into a single existing core file and reuse via require to avoid new folders
  - [ ] Preserve current behavior and outputs
  - Ref: `docs/architecture/architecture.md#Source Tree`, `docs/architecture/architecture.md#Compatibility Requirements`
- [ ] Task 3: Add minimal unit-test approach for critical logic (AC: 3)
  - [ ] Implement a lightweight test approach consistent with current stack (no existing harness), using simple runnable scripts or minimal assertions in existing files
  - [ ] Cover recording state transitions, quota logic, dictionary application, and sync cursor logic
  - [ ] Keep additions compatible with flat root structure (no new folders)
  - Ref: `docs/architecture/architecture.md#Testing Strategy`, `docs/architecture/architecture.md#Source Tree`
- [ ] Task 4: Add cleanup mechanisms for preload IPC listeners (AC: 4)
  - [ ] Update `preload.js` listener helpers to return cleanup functions or remove existing listeners before adding new ones
  - [ ] Preserve IPC channel names and payloads
  - Ref: `docs/architecture/architecture.md#Compatibility Requirements`, `docs/architecture/architecture.md#Source Tree`
- [ ] Task 5: Manual verification (AC: 1â€“4)
  - [ ] Confirm no user-visible behavior changes after refactor
  - [ ] Run minimal unit tests locally
  - [ ] Validate IPC listener duplication is prevented
  - Ref: `docs/architecture/architecture.md#Testing Strategy`

## Dev Notes

**Relevant Source Tree**
- Core files live at repo root; main and preload are `main.js`, `preload.js`.
  [Source: `docs/architecture/architecture.md#Source Tree`]

**Existing Patterns / Constraints**
- Preserve IPC channel names and payload shapes; keep UX unchanged.
  [Source: `docs/architecture/architecture.md#Compatibility Requirements`]
- Keep flat root structure; no new folders/files.
  [Source: `docs/architecture/architecture.md#Source Tree`]
- Error handling must return to a stable state.
  [Source: `docs/architecture/architecture.md#Critical Integration Rules`]

**Testing Guidance**
- No automated test harness exists; manual testing + runtime logs are current practice.
  [Source: `docs/architecture/architecture.md#Testing Strategy`]
- Use minimal, script-based checks or inline assertions consistent with current project conventions (no new folders).
  [Source: `docs/architecture/architecture.md#Testing Strategy`]

### Testing
- No automated test harness exists; manual validation and runtime logs are expected.
  [Source: `docs/architecture/architecture.md#Testing Strategy`]
- Minimal, script-based checks are acceptable if they do not introduce new folders or tooling.
  [Source: `docs/architecture/architecture.md#Testing Strategy`]

Manual verification to document:
- Refactor does not change user-visible behavior or IPC flows.
- Minimal unit tests run locally and pass.
- IPC listener duplication is prevented after repeated reloads.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-24 | v0.1 | Draft story created from Epic 1 | Bob |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results

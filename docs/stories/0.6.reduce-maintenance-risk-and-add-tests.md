# Story 1.6: reduce-maintenance-risk-and-add-tests

## Status
Ready for Review

## Story
**As a** developer,
**I want** the core logic modularized and covered by tests,
**so that** regressions are less likely and changes are safer.

**Epic alignment:** Supports Epic 1 goal to secure and stabilize the codebase.
**Dependencies:** None.

## Acceptance Criteria
1. main.js responsibilities are split into focused internal sections/functions without changing runtime behavior (no new folders/files required).
2. Shared utilities are de-duplicated (word count, subscription logic, retention logic).
3. A minimal unit-test approach exists for recording state transitions, quota logic, dictionary application, and sync cursor logic, using existing project conventions (no new folders required).
4. Preload IPC listeners provide cleanup mechanisms to avoid duplicate handlers.

## Tasks / Subtasks
- [x] Task 1: Modularize main process logic without behavior changes (AC: 1)
  - [x] Refactor `main.js` into clear, focused sections/functions (recording state, transcription pipeline, sync scheduling, tray/shortcuts) while preserving current IPC and UX
  - [x] Keep flat root structure; avoid new folders/files
  - Ref: `docs/architecture.md#Integration Approach`, `docs/architecture.md#Source Tree`, `docs/architecture.md#Compatibility Requirements`
- [x] Task 2: De-duplicate shared utilities across core files (AC: 2)
  - [x] Consolidate duplicate helpers (word count, subscription logic, retention logic) into a single existing core file and reuse via require to avoid new folders
  - [x] Preserve current behavior and outputs
  - Ref: `docs/architecture.md#Source Tree`, `docs/architecture.md#Compatibility Requirements`
- [x] Task 3: Add minimal unit-test approach for critical logic (AC: 3)
  - [x] Implement a lightweight test approach consistent with current stack (no existing harness), using simple runnable scripts or minimal assertions in existing files
  - [x] Cover recording state transitions, quota logic, dictionary application, and sync cursor logic
  - [x] Keep additions compatible with flat root structure (no new folders)
  - Ref: `docs/architecture.md#Testing Strategy`, `docs/architecture.md#Source Tree`
- [x] Task 4: Add cleanup mechanisms for preload IPC listeners (AC: 4)
  - [x] Update `preload.js` listener helpers to return cleanup functions or remove existing listeners before adding new ones
  - [x] Preserve IPC channel names and payloads
  - Ref: `docs/architecture.md#Compatibility Requirements`, `docs/architecture.md#Source Tree`
- [x] Task 5: Manual verification (AC: 1–4)
  - [x] Confirm no user-visible behavior changes after refactor
  - [x] Run minimal unit tests locally
  - [x] Validate IPC listener duplication is prevented
  - Ref: `docs/architecture.md#Testing Strategy`

## Dev Notes

**Relevant Source Tree**
- Core files live at repo root; main and preload are `main.js`, `preload.js`.
  [Source: `docs/architecture.md#Source Tree`]

**Existing Patterns / Constraints**
- Preserve IPC channel names and payload shapes; keep UX unchanged.
  [Source: `docs/architecture.md#Compatibility Requirements`]
- Keep flat root structure; no new folders/files.
  [Source: `docs/architecture.md#Source Tree`]
- Error handling must return to a stable state.
  [Source: `docs/architecture.md#Critical Integration Rules`]

**Testing Guidance**
- No automated test harness exists; manual testing + runtime logs are current practice.
  [Source: `docs/architecture.md#Testing Strategy`]
- Use minimal, script-based checks or inline assertions consistent with current project conventions (no new folders).
  [Source: `docs/architecture.md#Testing Strategy`]

### Testing
- No automated test harness exists; manual validation and runtime logs are expected.
  [Source: `docs/architecture.md#Testing Strategy`]
- Minimal, script-based checks are acceptable if they do not introduce new folders or tooling.
  [Source: `docs/architecture.md#Testing Strategy`]

Manual verification to document:
- Refactor does not change user-visible behavior or IPC flows.
- Minimal unit tests run locally and pass.
- IPC listener duplication is prevented after repeated reloads.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-24 | v0.1 | Draft story created from Epic 1 | Bob |
| 2026-01-24 | v1.0 | Modularize utilities, add core tests, and IPC listener cleanup | James |
| 2026-01-24 | v1.1 | Manual verification reported complete; DoD checklist recorded | James |

## Dev Agent Record

### Agent Model Used
GPT-5

### Debug Log References
N/A

### Completion Notes List
- Extracted shared utilities into store and reused across main/sync/store.
- Added a lightweight core test script covering critical logic.
- Added IPC listener cleanup helpers in preload.
- Manual verification reported complete by user.
- DoD: No build/lint run; test-core script executed.

### File List
- main.js
- preload.js
- store.js
- sync.js
- test-core.js

### DoD Checklist
1. Requirements Met
   - [x] All functional requirements specified in the story are implemented.
   - [x] All acceptance criteria defined in the story are met.
2. Coding Standards & Project Structure
   - [x] All new/modified code strictly adheres to `Operational Guidelines`.
   - [x] All new/modified code aligns with `Project Structure` (file locations, naming, etc.).
   - [x] Adherence to `Tech Stack` for technologies/versions used.
   - [N/A] Adherence to `Api Reference` and `Data Models` (no API/data model changes).
   - [x] Basic security best practices applied for new/modified code.
   - [x] No new linter errors or warnings introduced (no linter in repo).
   - [x] Code is well-commented where necessary (no complex logic added).
3. Testing
   - [x] Unit tests implemented via `test-core.js`.
   - [N/A] Integration tests implemented (no automated test harness).
   - [x] All tests pass successfully (`node test-core.js`).
   - [N/A] Test coverage meets project standards (none defined).
4. Functionality & Verification
   - [x] Functionality manually verified by user.
   - [x] Edge cases and potential error conditions considered and handled.
5. Story Administration
   - [x] All tasks within the story file are marked as complete.
   - [x] Clarifications/decisions documented in story file.
   - [x] Story wrap-up section completed (notes, model, changelog).
6. Dependencies, Build & Configuration
   - [ ] Project builds successfully without errors (not run).
   - [ ] Project linting passes (no linter configured, not run).
   - [x] No new dependencies added.
   - [N/A] New dependencies recorded with justification.
   - [N/A] Security vulnerabilities review for new deps.
   - [N/A] New env vars/config documented.
7. Documentation
   - [N/A] Inline docs for new public APIs (no new public APIs).
   - [N/A] User-facing documentation updates required.
   - [N/A] Technical documentation updates required.

- [ ] I, the Developer Agent, confirm that all applicable items above have been addressed.

## QA Results

### Review Date: 2026-02-01

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Review based on story documentation and file list (main.js, preload.js, store.js, sync.js, test-core.js). Manual verification is noted; automated QA execution not recorded. Refactor plus test-core script for critical logic and IPC listener cleanup.

### Refactoring Performed
None.

### Compliance Check
- Coding Standards: ✓ (per dev DoD; not re-verified in this pass; standards in docs/architecture/coding-standards.md)
- Project Structure: ✓ (file list confined to existing structure)
- Testing Strategy: ✓ (script-based tests reported in test-core.js; not re-run in this pass)
- All ACs Met: ✓ (per dev notes; not independently verified)

### Improvements Checklist

- [ ] Expand test-core coverage for error paths and IPC cleanup edge cases.
- [ ] Add a lightweight regression/smoke script for refactor-sensitive flows.

### Security Review
No security-sensitive changes.

### Performance Considerations
Refactor should be neutral; verify startup/recording latency remains stable.

### Files Modified During Review
None (QA artifacts only).

### Gate Status
Gate: CONCERNS -> docs/qa/gates/0.6-reduce-maintenance-risk-and-add-tests.yml
Risk profile: Not run
NFR assessment: Not run

### Recommended Status
[✗ Changes Required - See unchecked items above]
(Story owner decides final status)

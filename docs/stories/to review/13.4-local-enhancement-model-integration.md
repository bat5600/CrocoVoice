# Epic 13 — Local Enhancement Model Integration (Adaptive)

## Status
Ready for Review

## Story
**As a** user,  
**I want** CrocoVoice to locally enhance degraded audio when it helps,  
**so that** noisy or whispered dictations transcribe better without cloud dependency.

## Acceptance Criteria
1. A local enhancement model (e.g., DeepFilterNet) is integrated as an **optional** module.
2. Enhancement runs **only when the adaptive gate** (from 13.3) classifies audio as degraded/noisy.
3. If enhancement fails, the pipeline falls back to baseline audio without blocking dictation.
4. Enhancement is bounded by performance safeguards:
   - CPU usage limits
   - Max additional latency per chunk
5. Output audio remains mono, 16 kHz, float32 as required by Whisper.
6. No double-pass transcription is performed (baseline + enhanced).

## Tasks / Subtasks
- [x] Select and integrate local enhancement runtime (WASM/native).
- [x] Package model assets with clear size/boot-time constraints.
- [x] Wire enhancement into the capture pipeline **after** diagnostics decide to enhance.
- [x] Add fallback behavior if model is missing/unavailable.
- [x] Add feature flag + settings toggle for enhancement.
- [x] Add performance guards (skip enhancement when under load).

## Dev Notes
- Prefer a modular design so enhancement can be replaced or disabled easily.
- Avoid blocking the renderer thread; move heavy processing off the UI thread.

### Testing
- Manual: noisy audio improves with enhancement enabled.
- Manual: clean audio bypasses enhancement and latency is unchanged.
- Manual: remove/disable model → pipeline stays functional (baseline only).

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-25 | v0.1 | Story created for local enhancement integration | PM |

## Dev Agent Record
### Agent Model Used
GPT-5.2-Codex

### Debug Log References
N/A

### Completion Notes List
- Added optional local enhancement command hook gated by diagnostics.
- Added fallback behavior and performance safeguards.

### File List
- main.js
- dashboard.html

## QA Results

### Review Date: 2026-02-01

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Review based on story documentation and file list (main.js, dashboard.html). Manual verification is noted; automated QA execution not recorded. Local enhancement model integration and fallback.

### Refactoring Performed
None.

### Compliance Check
- Coding Standards: ✓ (per dev DoD; not re-verified in this pass; standards in docs/architecture/coding-standards.md)
- Project Structure: ✓ (file list confined to existing structure)
- Testing Strategy: ✗ (manual verification only; no automated coverage observed)
- All ACs Met: ✓ (per dev notes; not independently verified)

### Improvements Checklist

- [ ] Add tests for missing/disabled model fallback.
- [ ] Add latency/perf checks for enhancement path.
- [ ] Add regression test for clean-audio bypass.

### Security Review
No security-sensitive changes.

### Performance Considerations
Latency impact unmeasured.

### Files Modified During Review
None (QA artifacts only).

### Gate Status
Gate: CONCERNS -> docs/qa/gates/13.4-local-enhancement-model-integration-adaptive.yml
Risk profile: Not run
NFR assessment: Not run

### Recommended Status
[✗ Changes Required - See unchecked items above]
(Story owner decides final status)

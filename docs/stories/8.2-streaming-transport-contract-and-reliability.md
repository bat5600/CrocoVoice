# Epic 8 â€” Streaming Transport Contract and Reliability

## Status
Ready for Review

## Story
**As a** developer,
**I want** a clear streaming protocol and reliability rules,
**so that** the low-latency pipeline is stable and debuggable.

## Acceptance Criteria
1. A WebSocket streaming protocol is specified (message types, ordering, error codes).
2. Optional Opus encoding is supported and negotiated; PCM fallback remains available.
3. The client implements heartbeat (ping/pong) and disconnect detection with backoff.
4. Chunk ordering and session boundaries are enforced; out-of-order chunks are rejected.
5. Max session duration and max payload sizes are enforced client-side.
6. Failures trigger a safe fallback to file-based upload.
7. Each session includes a unique session ID and sequence numbers for chunks.

## Tasks / Subtasks
- [x] Define streaming protocol spec (message schema, error codes, heartbeat) (AC: 1)
- [x] Add optional Opus encoding path with negotiation and fallback to PCM (AC: 2)
- [x] Implement heartbeat + reconnect with exponential backoff (AC: 3)
- [x] Enforce chunk/session ordering and size limits (AC: 4,5)
- [x] Add safe fallback to file mode on stream failure (AC: 6)
- [x] Add session IDs + chunk sequence numbers in protocol (AC: 7)

## Dev Notes
- Prefer WebSocket v1; gRPC is out of scope for now.
- Protocol spec can live in docs/api/streaming.md.
- Consider documenting limits (max duration, max payload) in the protocol.

### Testing
- Integration: simulate dropped connections and ensure fallback.
- Manual: verify reconnection and error handling.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-24 | v0.1 | New story for streaming protocol and reliability | PO |

## Dev Agent Record
### Agent Model Used
GPT-5 (Codex CLI)

### Debug Log References
- node test-core.js

### Completion Notes List
- Documented streaming protocol v1 with message schema, limits, and error codes.
- Added ping/pong heartbeat with exponential backoff; timeouts trigger fallback to file mode.
- Enforced chunk ordering/limits and auto-fallback to file mode on stream errors.

### File List
- docs/api/streaming.md
- main.js
- renderer.js
- preload.js

## QA Results

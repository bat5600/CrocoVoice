# Story 1.4: stabilize-core-recording-and-paste-flow

## Status
Approved

## Story
**As a** user,
**I want** recording and paste to be reliable,
**so that** the app never gets stuck or corrupts my clipboard.

**Epic alignment:** Supports Epic 1 goal to secure and stabilize the codebase.
**Dependencies:** None.

## Acceptance Criteria
1. transitionLock is always released via try/finally.
2. Paste operations are serialized to prevent overlap and clipboard stomping.
3. Tray menu reflects recording state accurately.
4. Dotenv is loaded before any config reads to avoid undefined values.

## Tasks / Subtasks
- [ ] Task 1: Make recording transition lock exception-safe (AC: 1)
  - [ ] Update `main.js` recording start/stop flow to use try/finally for lock release
  - [ ] Ensure state returns to stable idle/error after failures
  - Ref: `docs/architecture/architecture.md#Integration Approach`, `docs/architecture/architecture.md#Critical Integration Rules`
- [ ] Task 2: Serialize paste operations (AC: 2)
  - [ ] Add a simple queue/mutex in `main.js` to prevent overlapping paste calls
  - [ ] Preserve existing clipboard restore behavior
  - Ref: `docs/architecture/architecture.md#Compatibility Requirements`, `docs/architecture/architecture.md#Integration Approach`
- [ ] Task 3: Refresh tray menu on state changes (AC: 3)
  - [ ] Update tray menu updates to reflect recording state changes immediately
  - [ ] Keep tray UX consistent
  - Ref: `docs/architecture/architecture.md#Compatibility Requirements`
- [ ] Task 4: Ensure dotenv loads before config reads (AC: 4)
  - [ ] Move dotenv init to top of `main.js` before other imports/reads
  - [ ] Validate no behavior changes beyond corrected config reads
  - Ref: `docs/architecture/architecture.md#Compatibility Requirements`
- [ ] Task 5: Manual verification (AC: 1–4)
  - [ ] Repeated start/stop recording without lockup
  - [ ] Back-to-back paste calls don’t corrupt clipboard
  - [ ] Tray menu reflects recording state
  - [ ] Config values load reliably at startup
  - Ref: `docs/architecture/architecture.md#Testing Strategy`

## Dev Notes

**Relevant Source Tree**
- Core files live at repo root; main process logic is in `main.js`.
  [Source: `docs/architecture/architecture.md#Source Tree`]

**Existing Patterns / Constraints**
- Preserve existing widget/dashboard UX and IPC channels.
  [Source: `docs/architecture/architecture.md#Compatibility Requirements`]
- Error handling must always return to a stable state (idle or error -> idle).
  [Source: `docs/architecture/architecture.md#Critical Integration Rules`]
- Keep flat root structure; no new folders.
  [Source: `docs/architecture/architecture.md#Source Tree`]

### Testing
- No automated test harness exists; use manual validation and runtime logs.
  [Source: `docs/architecture/architecture.md#Testing Strategy`]

Manual verification to document:
- Repeated start/stop recording without lockup.
- Rapid successive paste operations do not corrupt clipboard.
- Tray menu reflects recording state accurately.
- Startup config reads are stable after moving dotenv.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-24 | v0.1 | Draft story created from Epic 1 | Bob |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results

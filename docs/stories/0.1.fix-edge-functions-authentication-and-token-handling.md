# Story 1.1: fix-edge-functions-authentication-and-token-handling

## Status
InProgress

## Story
**As a** user,
**I want** server-side authentication to be properly verified,
**so that** unauthorized access to quota and billing endpoints is prevented.

**Epic alignment:** Supports Epic 1 goal to secure and stabilize the codebase.
**Dependencies:** None.

## Acceptance Criteria
1. Only JWTs with valid signatures are accepted by Edge Functions.
2. Stripe checkout/portal functions reuse shared auth verification logic.
3. Access tokens are not sent in request bodies when Authorization headers are present.
4. Regression tests or local validation steps confirm no auth bypass.

## Tasks / Subtasks
- [x] Task 1: Replace ad-hoc JWT parsing with verified Supabase auth in shared Edge Functions auth helper (AC: 1,2)
  - [x] Update `supabase/functions/_shared/auth.ts` to verify token signature via Supabase auth (`auth.getUser()` with Authorization header) and return validated user
  - [x] Remove manual base64 JWT parsing and issuer/exp checks that bypass signature verification
  - [x] Ensure errors are explicit and consistent (401/403)
  - Ref: `docs/architecture.md#Integration Approach`, `docs/architecture.md#Critical Integration Rules`
- [x] Task 2: Refactor Stripe Edge Functions to reuse shared auth helper (AC: 2)
  - [x] Update `supabase/functions/stripe-checkout/index.ts` to call shared auth verifier
  - [x] Update `supabase/functions/stripe-portal/index.ts` to call shared auth verifier
  - [x] Remove duplicate JWT parsing in Stripe functions
  - Ref: `docs/architecture.md#Integration Approach`
- [x] Task 3: Stop sending access tokens in Edge Function request bodies (AC: 3)
  - [x] Update `sync.js` invokeFunction to only send Authorization header
  - [x] Ensure Edge Functions read auth from headers only
  - Ref: `docs/architecture.md#Critical Integration Rules`
- [ ] Task 4: Validate auth behavior locally / via lightweight checks (AC: 4)
  - [ ] Verify valid token succeeds for checkout/portal/quota
  - [ ] Verify invalid/forged token is rejected
  - [ ] Document manual verification steps in the story Testing section
  - Ref: `docs/architecture.md#Testing Strategy`

## Dev Notes

**Relevant Source Tree**
- Core files live at repo root and `supabase/` for Edge Functions.
  [Source: `docs/architecture.md#Source Tree`]

**Existing Patterns / Constraints**
- Keep existing IPC and app behavior unchanged; changes are scoped to Edge Functions + sync client.
  [Source: `docs/architecture.md#Compatibility Requirements`]
- Preserve current stack; no new tech required.
  [Source: `docs/architecture.md#Tech Stack`]

**Security Notes**
- No specific guidance found in architecture docs for Edge Function auth verification details. Follow existing integration constraints and keep changes additive.
  [Source: `docs/architecture.md#Compatibility Requirements`]

**Integration Guidance**
- Changes must be additive and backward compatible.
  [Source: `docs/architecture.md#Compatibility Requirements`]
- Keep the flat root structure; do not add new folders.
  [Source: `docs/architecture.md#Source Tree`]

### Testing
- No automated test harness exists; use manual validation steps for Edge Functions auth and Stripe flows.
  [Source: `docs/architecture.md#Testing Strategy`]
- Manual regression steps and runtime logs are the expected verification approach.
  [Source: `docs/architecture.md#Testing Strategy`]

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-24 | v0.1 | Draft story created from Epic 1 | Bob |
| 2026-01-24 | v0.2 | Align story sources to architecture-only guidance | Bob |
| 2026-01-24 | v1.0 | Implemented auth verification changes and sync token removal | James |

## Dev Agent Record

### Agent Model Used
GPT-5 (Codex)

### Debug Log References
None.

### Completion Notes List
- Implemented shared auth verification via Supabase `auth.getUser()` and removed manual JWT parsing.
- Stripe checkout/portal now use shared auth helper and propagate auth errors via status codes.
- Sync function calls no longer include access token in request body.
- Manual verification for auth flows not run (requires runtime credentials).

### File List
- supabase/functions/_shared/auth.ts
- supabase/functions/stripe-checkout/index.ts
- supabase/functions/stripe-portal/index.ts
- sync.js
- docs/stories/1.1.fix-edge-functions-authentication-and-token-handling.md

## QA Results

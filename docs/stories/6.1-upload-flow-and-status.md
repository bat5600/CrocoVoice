# Epic 6 — Upload Flow and Status (Local File Transcription)

## Status
InProgress

## Story
**As a** user,
**I want** to import a long audio file and see processing progress,
**so that** it is transcribed into a Note without live dictation.

## Acceptance Criteria
1. The app lets me select a local audio file (wav/mp3/m4a) for transcription import.
2. Processing is local by default (no upload); cloud fallback requires explicit opt-in.
3. Import creates a transient Note (or import item) immediately and shows stages (queued, processing, completed, failed) and percent where possible.
4. Cancel is always allowed (queued or processing), never crashes/freezes the app, deletes the transient Note, and leaves no history entry.
5. On completion, the Note contains the formatted transcript and file metadata (name, duration, size).
6. Failures show a clear reason and preserve the original file reference locally (local-only; never synced).
7. Large files are handled with a configurable size limit (default: 200MB) and clear error messaging.
8. Transcription runs in a background job and does not block the UI thread.

## Tasks / Subtasks
- [x] Add file picker entry point in hub (AC: 1)
- [x] Implement local file transcription pipeline (AC: 2)
- [x] Add progress/status tracking and UI updates (AC: 3)
- [x] Fix queue → processing transition (stuck “queued” regression) (AC: 3)
- [x] Make cancel reliable and always available; cancel deletes transient note and leaves no history entry (AC: 4)
- [x] Persist transcript + metadata in Notes (and never sync local file paths) (AC: 5,6)
- [x] Persist failed upload records with file reference + error for later review (AC: 6)
- [x] Add opt-in cloud fallback toggle and gating (AC: 2)
- [x] Enforce size limits and user-friendly errors (AC: 7)
- [x] Run transcription as a background job (AC: 8)
- [x] Add structured manual test script for upload flow + cancellation edge cases (AC: 1–8)

## Dev Notes
- Local processing should prefer on-device Whisper if available; otherwise fail with a clear message unless cloud fallback is enabled.
- Store a reference to the original file path (local-only) and avoid uploading it without consent.
- Default size limit should be configurable via settings.

### Testing
- Manual: upload small/large files, cancel mid-way, verify Notes entry + no history entry.
- Offline: verify local-only path; cloud fallback remains disabled.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-25 | v0.1 | Reactivated Epic 6 upload flow story | PO |
| 2026-02-01 | v0.2 | Video review updates: import → Notes, cancel deletes note, fix queued/cancel regressions | PM |
| 2026-02-01 | v0.3 | Persisted upload jobs + transient notes; improved cancel; added manual test script | Dev |

## Dev Agent Record
### Agent Model Used
GPT-5 (Codex CLI)

### Debug Log References
- node test-core.js

### Completion Notes List
- Added upload picker + queue with cancel/progress UI in the hub.
- Implemented cloud-fallback transcription with size limits and history metadata.
- Redacted local file paths from sync payloads.
- Updated upload UI copy to reflect notes-based storage.
- Persisted upload job records (including failures) and added transient notes for uploads.
- Formatted upload transcripts via the text pipeline and stored full file metadata.
- Added manual test script for upload flow and cancellation.
- Redacted local file paths from upload note metadata during sync.

### File List
- main.js
- dashboard.html
- dashboard.js
- preload.js
- sync.js
- store.js
- docs/tests/manual-upload-flow.md

## QA Results

### Review Date: 2026-02-01

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Implementation is cohesive and integrates upload flow across main/renderer with clear status updates and settings gating. However, multiple acceptance criteria and privacy requirements remain unmet, and there is no automated test coverage for this feature.

### Refactoring Performed
None.

### Compliance Check
- Coding Standards: ✓ (matches existing JS/CommonJS style)
- Project Structure: ✗ (reference doc `docs/unified-project-structure.md` not found)
- Testing Strategy: ✗ (reference doc `docs/testing-strategy.md` not found; no automated tests for upload flow)
- All ACs Met: ✗ (history target mismatch; failure persistence gap; duration metadata missing for non-WAV; local-by-default behavior unclear)

### Improvements Checklist
- [ ] Redact local file paths from notes metadata before sync (privacy/local-only requirement).
- [ ] Persist upload transcripts in history (or update AC/design) and include full file metadata (name, duration for all formats, size).
- [ ] Persist failed upload records with file reference + error for later review (AC6).
- [ ] Add automated tests or structured manual scripts for upload flow (AC1–AC8) and cancellation edge cases.
- [ ] Surface percent text (or stage-specific messaging) alongside the progress bar.

### Security Review
Local file paths from upload metadata are currently synced to remote notes, which violates the “local-only” requirement. Cloud fallback remains opt-in, but file paths should be redacted before sync.

### Performance Considerations
Processing reads entire audio files into memory (up to 200MB). Acceptable for now but may cause memory pressure; consider streaming/chunking for very large files.

### Files Modified During Review
None.

### Gate Status
Gate: FAIL → docs/qa/gates/6.1-upload-flow-and-status-local-file-transcription.yml  
Risk profile: docs/qa/assessments/6.1-risk-20260201.md (not generated)  
NFR assessment: docs/qa/assessments/6.1-nfr-20260201.md (not generated)

### Recommended Status
[✗ Changes Required - See unchecked items above]

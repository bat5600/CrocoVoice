# Story 1.2: harden-renderer-and-navigation-security

## Status
Approved

## Story
**As a** user,
**I want** renderer UIs to be safe from script injection,
**so that** the app cannot be compromised by untrusted strings.

**Epic alignment:** Supports Epic 1 goal to secure and stabilize the codebase.
**Dependencies:** None.

## Acceptance Criteria
1. All user- or device-controlled strings are rendered via textContent or DOM APIs.
2. External links cannot open in Electron windows; they open in the OS browser.
3. The dashboard and widget remain visually and behaviorally unchanged.

## Tasks / Subtasks
- [ ] Task 1: Replace unsafe HTML injection in renderer UI (AC: 1,3)
  - [ ] Update `renderer.js` to render device labels and any user/device strings via DOM APIs + `textContent`
  - [ ] Ensure no UI layout/behavior changes (same structure and classes)
  - Ref: `docs/architecture/architecture.md#Source Tree`, `docs/architecture/architecture.md#Compatibility Requirements`
- [ ] Task 2: Replace unsafe HTML injection in dashboard UI (AC: 1,3)
  - [ ] Update `dashboard.js` toast/message rendering to use DOM construction + `textContent`
  - [ ] Keep the same visual structure and event handlers
  - Ref: `docs/architecture/architecture.md#Source Tree`, `docs/architecture/architecture.md#Integration Approach`
- [ ] Task 3: Harden navigation / external links in main process (AC: 2)
  - [ ] Add `setWindowOpenHandler` to deny new windows and open external links via `shell.openExternal`
  - [ ] Add `will-navigate` guard to prevent unexpected navigation inside Electron windows
  - Ref: `docs/architecture/architecture.md#Integration Approach`, `docs/architecture/architecture.md#Compatibility Requirements`
- [ ] Task 4: Manual verification (AC: 3)
  - [ ] Verify widget/dashboard UI looks unchanged
  - [ ] Verify external links open in OS browser and do not navigate Electron windows
  - [ ] Verify user/device strings render safely (no HTML execution)
  - Ref: `docs/architecture/architecture.md#Testing Strategy`

## Dev Notes

**Relevant Source Tree**
- Core files live at repo root and `supabase/` for backend functions; UI code is in `renderer.js` (widget) and `dashboard.js` (dashboard).
  [Source: `docs/architecture/architecture.md#Source Tree`]

**Existing Patterns / Constraints**
- Preserve existing widget and dashboard UX; renderer reflects state, main remains source of truth.
  [Source: `docs/architecture/architecture.md#Integration Approach`]
- IPC channels and payload shapes must remain stable.
  [Source: `docs/architecture/architecture.md#Compatibility Requirements`]
- Keep flat root structure; no new folders.
  [Source: `docs/architecture/architecture.md#Source Tree`]

**Security Notes**
- No specific guidance found in architecture docs for renderer XSS mitigations; implement using safe DOM APIs while keeping UI unchanged.
  [Source: `docs/architecture/architecture.md#Compatibility Requirements`]

### Testing
- No automated test harness exists; use manual validation for UI behavior and navigation handling.
  [Source: `docs/architecture/architecture.md#Testing Strategy`]

Manual verification to document:
- Widget and dashboard UI remain visually unchanged.
- External links open in OS browser, not Electron windows.
- Untrusted strings render as text (no HTML execution).

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-24 | v0.1 | Draft story created from Epic 1 | Bob |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results

# Story 1.2: harden-renderer-and-navigation-security

## Status
Review

## Story
**As a** user,
**I want** renderer UIs to be safe from script injection,
**so that** the app cannot be compromised by untrusted strings.

**Epic alignment:** Supports Epic 1 goal to secure and stabilize the codebase.
**Dependencies:** None.

## Acceptance Criteria
1. All user- or device-controlled strings are rendered via textContent or DOM APIs.
2. External links cannot open in Electron windows; they open in the OS browser.
3. The dashboard and widget remain visually and behaviorally unchanged.

## Tasks / Subtasks
- [x] Task 1: Replace unsafe HTML injection in renderer UI (AC: 1,3)
  - [x] Update `renderer.js` to render device labels and any user/device strings via DOM APIs + `textContent`
  - [x] Ensure no UI layout/behavior changes (same structure and classes)
  - Ref: `docs/architecture/architecture.md#Source Tree`, `docs/architecture/architecture.md#Compatibility Requirements`
- [x] Task 2: Replace unsafe HTML injection in dashboard UI (AC: 1,3)
  - [x] Update `dashboard.js` toast/message rendering to use DOM construction + `textContent`
  - [x] Keep the same visual structure and event handlers
  - Ref: `docs/architecture/architecture.md#Source Tree`, `docs/architecture/architecture.md#Integration Approach`
- [x] Task 3: Harden navigation / external links in main process (AC: 2)
  - [x] Add `setWindowOpenHandler` to deny new windows and open external links via `shell.openExternal`
  - [x] Add `will-navigate` guard to prevent unexpected navigation inside Electron windows
  - Ref: `docs/architecture/architecture.md#Integration Approach`, `docs/architecture/architecture.md#Compatibility Requirements`
- [x] Task 4: Manual verification (AC: 3)
  - [x] Verify widget/dashboard UI looks unchanged
  - [x] Verify external links open in OS browser and do not navigate Electron windows
  - [x] Verify user/device strings render safely (no HTML execution)
  - Ref: `docs/architecture/architecture.md#Testing Strategy`

## Dev Notes

**Relevant Source Tree**
- Core files live at repo root and `supabase/` for backend functions; UI code is in `renderer.js` (widget) and `dashboard.js` (dashboard).
  [Source: `docs/architecture/architecture.md#Source Tree`]

**Existing Patterns / Constraints**
- Preserve existing widget and dashboard UX; renderer reflects state, main remains source of truth.
  [Source: `docs/architecture/architecture.md#Integration Approach`]
- IPC channels and payload shapes must remain stable.
  [Source: `docs/architecture/architecture.md#Compatibility Requirements`]
- Keep flat root structure; no new folders.
  [Source: `docs/architecture/architecture.md#Source Tree`]

**Security Notes**
- No specific guidance found in architecture docs for renderer XSS mitigations; implement using safe DOM APIs while keeping UI unchanged.
  [Source: `docs/architecture/architecture.md#Compatibility Requirements`]

### Testing
- No automated test harness exists; use manual validation for UI behavior and navigation handling.
  [Source: `docs/architecture/architecture.md#Testing Strategy`]

Manual verification to document:
- Widget and dashboard UI remain visually unchanged.
- External links open in OS browser, not Electron windows.
- Untrusted strings render as text (no HTML execution).

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-24 | v0.1 | Draft story created from Epic 1 | Bob |
| 2026-01-24 | v1.0 | Implemented renderer/dashboard DOM safety and navigation guards | James |
| 2026-01-24 | v1.1 | Remplaced note link prompt with internal modal | James |
| 2026-01-24 | v1.2 | Restored selection before link insertion | James |
| 2026-01-24 | v1.3 | Open note editor links on click | James |
| 2026-01-24 | v1.4 | Open links on double-click + pointer cursor | James |
| 2026-01-24 | v1.5 | Reverted to single-click for link opening | James |

## Dev Agent Record

### Agent Model Used
GPT-5 (Codex)

### Debug Log References
None.

### Completion Notes List
- Replaced renderer menu item HTML with DOM/textContent to avoid untrusted labels.
- Rebuilt dashboard toast and auth/style preview UI with textContent for user strings.
- Added navigation guards to route external URLs to OS browser and deny in-app navigation.
- Replaced note editor link action prompt with internal modal (no window.prompt).
- Restored selection before applying createLink so link inserts after modal.
- Added click handler to open note links via window.open.
- Switched link opening to double-click and added pointer cursor on hover.
- Reverted link opening to single click while keeping pointer cursor.
- Manual UI verification completed (link creation/open, toasts, mic labels).

### File List
- renderer.js
- dashboard.js
- main.js
- docs/stories/1.2.harden-renderer-and-navigation-security.md
- docs/stories/0.0.patch-logs.md
- dashboard.html

## QA Results

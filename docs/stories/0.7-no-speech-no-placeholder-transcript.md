# Patch Story — No Speech / No Placeholder Transcript (Regression)

## Status
Review

## Story
**As a** user,  
**I want** the app to never generate fake/placeholder transcript text when no speech is detected,  
**so that** my clipboard/history/notes are not polluted with nonsense.

## Background
Video review reports that when there is no text/audio, the app outputs a “fake transcript” (placeholder text). This is a trust-breaking failure mode and must be handled as “no speech/no audio”.

## Acceptance Criteria
1. If no audio is captured (or capture times out), the UI shows a clear “No audio / No speech detected” message and **no transcript is produced** (no paste/type/clipboard insert).
2. If ASR returns empty/whitespace or known filler/hallucination strings, treat it as “no speech” and do not emit a transcript.
3. No History entry and no Note is created for “no speech” outcomes.
4. App returns to idle cleanly after the warning (no stuck “processing” state).
5. Existing IPC channels remain stable (no breaking changes).

## Tasks / Subtasks
- [x] Identify the current code path producing placeholder/fake text when ASR output is empty.
- [x] Centralize “no speech” detection (empty + filler patterns) and short-circuit the pipeline safely.
- [x] Ensure no persistence occurs for no-speech (history/notes/last transcript).
- [x] Add a minimal manual regression script (silence input, muted mic, short noise).

## Dev Notes
- There is a prior implemented story in `docs/stories/done/1.10.alerter-absence-audio-et-supprimer-faux-texte.md`; this patch story is for a regression or missed edge-case.

### Testing
- Manual: run dictation with muted mic/silence, confirm warning and zero text insertion.
- Manual: simulate ASR returning empty string and known filler text.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-02-01 | v0.1 | Story created from video review (fake transcript on no speech) | PM |
| 2026-02-01 | v0.2 | Implemented stricter no-speech detection + no-transcript flow | Dev |
| 2026-02-01 | v0.3 | Guard post-process refusals + allow short numeric utterances | Dev |
| 2026-02-01 | v0.4 | Skip Whisper on near-silence + mic name in no-audio errors | Dev |

## Dev Agent Record
### Agent Model Used
GPT-5.2 (Codex CLI)

### Debug Log References
- node test-core.js
- Not run (this update).

### Completion Notes List
- Centralized no-speech detection with diagnostics-assisted checks and extra placeholder guards.
- Ensured no-speech paths emit error messaging and do not persist history/notes/last transcription.
- Post-process refusals (e.g., “je suis désolé…”) now fall back to raw transcript.
- Short numeric utterances (e.g., “1, 2”) are no longer dropped when diagnostics indicate low audio.
- Pre-transcription silence gate skips Whisper on near-empty audio to avoid subtitle hallucinations (e.g., SousTitreur).
- No-audio/low-audio errors now include the active microphone label/id for easier troubleshooting.
- Manual regression script (to run): 1) mute mic/silence; 2) short noise; 3) very short utterance; expect “No audio / No speech detected” and no transcript.

### File List
- main.js

## QA Results

### Review Date: 2026-02-01

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Implementation is concise and localized (main.js only). The pre-transcription silence gate and expanded hallucination filters are clear, but thresholds are heuristic and currently untested beyond manual checks.

### Refactoring Performed
None.

### Compliance Check
- Coding Standards: ✓ (reviewed against `docs/architecture/coding-standards.md`; `docs/coding-standards.md` not found)
- Project Structure: ✓ (no new source file locations introduced)
- Testing Strategy: ✗ (no automated tests; `docs/testing-strategy.md` not found)
- All ACs Met: ✓ (AC3/AC5 verified via code review; no automated coverage)

### Improvements Checklist
- [ ] Add automated tests covering silence, low audio, and subtitle-hallucination strings.
- [ ] Add a regression test ensuring no History/Note is created on no-speech outcomes.
- [ ] Validate/adjust silence thresholds with a small sample set of quiet speech.

### Security Review
No security-sensitive changes detected.

### Performance Considerations
Early silence skip reduces unnecessary Whisper calls (cost/latency improvement).

### Files Modified During Review
None (QA artifacts only).

### Gate Status
Gate: CONCERNS → docs/qa/gates/0.7-patch-story-no-speech-no-placeholder-transcript-regression.yml  
Risk profile: Not run  
NFR assessment: Not run

### Recommended Status
[✗ Changes Required - See unchecked items above]  
(Story owner decides final status)

### Review Date: 2026-02-01

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Review based on story documentation and file list (main.js). Manual verification is noted; automated QA execution not recorded. No-speech detection and pipeline short-circuiting in main.js.

### Refactoring Performed
None.

### Compliance Check
- Coding Standards: ✓ (per dev DoD; not re-verified in this pass; standards in docs/architecture/coding-standards.md)
- Project Structure: ✓ (file list confined to existing structure)
- Testing Strategy: ✗ (manual verification only; no automated coverage observed)
- All ACs Met: ✓ (per dev notes; not independently verified)

### Improvements Checklist

- [ ] Add automated regression tests for silence/placeholder detection.
- [ ] Add a test to ensure no history/note created on no-speech outcomes.
- [ ] Tune/validate silence thresholds with a small sample set.

### Security Review
No security-sensitive changes.

### Performance Considerations
Early silence gate reduces unnecessary ASR calls.

### Files Modified During Review
None (QA artifacts only).

### Gate Status
Gate: CONCERNS -> docs/qa/gates/0.7-patch-story-no-speech-no-placeholder-transcript-regression.yml
Risk profile: Not run
NFR assessment: Not run

### Recommended Status
[✗ Changes Required - See unchecked items above]
(Story owner decides final status)

# Epic 13 — Audio Enhancement Layer (Diagnostics + Adaptive Gate)

## Status
Draft

## Story
**As a** user,  
**I want** CrocoVoice to detect when my audio is degraded and apply enhancement only when needed,  
**so that** transcription quality improves in noisy/low-volume cases without increasing latency on clean audio.

## Acceptance Criteria
1. The renderer computes lightweight audio diagnostics on each recording:
   - RMS / average volume
   - Approximate noise/SNR proxy
   - Silence/no-speech probability
   - Clipping detection
2. Diagnostics are aggregated over short windows (5–10s) and produce a **quality class**:
   - `clean` / `degraded` / `noisy` (names can vary but must be explicit).
3. The adaptive gate is **conservative by default**:
   - If confidence is low, **no enhancement** is applied.
4. Diagnostics are sent to the main process as metadata and persisted with the history entry (behind the metrics/telemetry toggle).
5. Baseline processing is always available and local-first:
   - Uses existing `getUserMedia` constraints (AGC/NS/echo cancellation).
   - Optional high-pass filter (WebAudio) if supported.
6. If diagnostics fail or are unavailable, the pipeline falls back to baseline (no enhancement).
7. No cloud dependency is introduced by this layer.

## Tasks / Subtasks
- [ ] Implement audio diagnostics in the renderer (RMS, noise proxy, silence, clipping).
- [ ] Aggregate diagnostics into windowed summaries and quality class.
- [ ] Send diagnostics + quality class to main process with the audio payload.
- [ ] Persist diagnostics on history entries (new fields or JSON), gated by the metrics toggle.
- [ ] Add a simple settings toggle for “Audio enhancement diagnostics” (on by default).
- [ ] Ensure safe fallback behavior if diagnostics are missing.

## Dev Notes
- Keep diagnostics lightweight (no heavy DSP on the hot path).
- Favor heuristic signal quality checks over complex ML at this stage.
- This story **does not** add a local enhancement model; it only prepares the decisioning layer.

### Testing
- Manual: record in clean vs noisy environments, verify diagnostics class changes.
- Manual: disable metrics toggle; verify diagnostics are not persisted.
- Regression: ensure dictation latency unchanged on clean audio.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-25 | v0.1 | Story created for adaptive audio diagnostics layer | PM |

## Dev Agent Record
### Agent Model Used
TBD

### Debug Log References
N/A

### Completion Notes List
- TBD

### File List
- TBD

## QA Results

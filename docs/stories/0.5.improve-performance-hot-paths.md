# Story 1.5: improve-performance-hot-paths

## Status
Ready for Review

## Story
**As a** user,
**I want** faster processing for long recordings and large history lists,
**so that** the app remains responsive over time.

**Epic alignment:** Supports Epic 1 goal to secure and stabilize the codebase.
**Dependencies:** None.

## Acceptance Criteria
1. Audio IPC sends ArrayBuffer directly without Array-from JSON conversion.
2. SQLite indexes are added for history/notes/dictionary/styles sorting and purge queries.
3. Settings writes avoid bulk upserts when only one key changes.
4. Dictionary lookups are cached or optimized without altering results.

## Tasks / Subtasks
- [x] Task 1: Optimize audio IPC payload (AC: 1)
  - [x] Update `renderer.js` to send ArrayBuffer directly over IPC
  - [x] Update `main.js` to consume raw ArrayBuffer without JSON conversion
  - Ref: `docs/architecture.md#Source Tree`, `docs/architecture.md#Integration Approach`
- [x] Task 2: Add SQLite indexes for hot queries (AC: 2)
  - [x] Add `CREATE INDEX IF NOT EXISTS` for history/notes/dictionary/styles ordering and purge queries
  - [x] Keep schema changes additive and non-destructive
  - Ref: `docs/architecture.md#Compatibility Requirements`, `docs/architecture.md#Data Models and Schema Changes`
- [x] Task 3: Reduce settings write amplification (AC: 3)
  - [x] Update settings writes to avoid bulk upserts when only one key changes
  - [x] Preserve current settings behavior and defaults
  - Ref: `docs/architecture.md#Compatibility Requirements`, `docs/architecture.md#Integration Approach`
- [x] Task 4: Optimize dictionary lookups (AC: 4)
  - [x] Cache dictionary entries in memory and invalidate on upsert/delete
  - [x] Preserve existing dictionary behavior and output
  - Ref: `docs/architecture.md#Compatibility Requirements`, `docs/architecture.md#Integration Approach`
- [x] Task 5: Manual verification (AC: 1–4)
  - [x] Long recordings process faster without UI regressions
  - [x] History/notes lists remain responsive as data grows
  - [x] Settings changes still persist correctly
  - [x] Dictionary application results are unchanged
  - Ref: `docs/architecture.md#Testing Strategy`

## Dev Notes
- Cette story n’implique pas que le pipeline audio actuel soit final ou figé.
- Les optimisations doivent rester compatibles avec l’ajout futur de traitements audio conditionnels.

**Relevant Source Tree**
- Core files live at repo root; renderer/main/store are `renderer.js`, `main.js`, `store.js`.
  [Source: `docs/architecture.md#Source Tree`]

**Existing Patterns / Constraints**
- Preserve existing UI behavior and IPC channels.
  [Source: `docs/architecture.md#Compatibility Requirements`]
- No destructive schema changes to local SQLite.
  [Source: `docs/architecture.md#Compatibility Requirements`]
- Keep flat root structure; no new folders.
  [Source: `docs/architecture.md#Source Tree`]

**Data/Schema Guidance**
- No new tables are defined; any DB changes must be additive.
  [Source: `docs/architecture.md#Data Models and Schema Changes`]

### Testing
- No automated test harness exists; use manual validation and runtime logs.
  [Source: `docs/architecture.md#Testing Strategy`]

Manual verification to document:
- Long recordings process faster; no UI regressions.
- History/notes lists remain responsive as data grows.
- Settings changes still persist correctly.
- Dictionary application results are unchanged.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-24 | v0.1 | Draft story created from Epic 1 | Bob |
| 2026-01-24 | v1.0 | Optimize audio IPC payload, add indexes, reduce settings writes, cache dictionary | James |
| 2026-01-24 | v1.1 | Manual verification reported complete; DoD checklist recorded | James |

## Dev Agent Record

### Agent Model Used
GPT-5

### Debug Log References
N/A

### Completion Notes List
- Audio IPC now sends ArrayBuffer directly to main process.
- Added SQLite indexes for history/notes/dictionary/styles hot queries.
- Settings writes optimized to avoid full upserts on single-key changes.
- Dictionary lookups cached with invalidation on updates.
- Manual verification reported complete by user.
- DoD: No automated tests, build, or lint run (not available in repo); manual verification only.

### File List
- main.js
- renderer.js
- store.js

### DoD Checklist
1. Requirements Met
   - [x] All functional requirements specified in the story are implemented.
   - [x] All acceptance criteria defined in the story are met.
2. Coding Standards & Project Structure
   - [x] All new/modified code strictly adheres to `Operational Guidelines`.
   - [x] All new/modified code aligns with `Project Structure` (file locations, naming, etc.).
   - [x] Adherence to `Tech Stack` for technologies/versions used.
   - [N/A] Adherence to `Api Reference` and `Data Models` (no API/data model changes).
   - [x] Basic security best practices applied for new/modified code.
   - [x] No new linter errors or warnings introduced (no linter in repo).
   - [x] Code is well-commented where necessary (no complex logic added).
3. Testing
   - [N/A] Unit tests implemented (no automated test harness).
   - [N/A] Integration tests implemented (no automated test harness).
   - [ ] All tests pass successfully (not run).
   - [N/A] Test coverage meets project standards (none defined).
4. Functionality & Verification
   - [x] Functionality manually verified by user.
   - [x] Edge cases and potential error conditions considered and handled.
5. Story Administration
   - [x] All tasks within the story file are marked as complete.
   - [x] Clarifications/decisions documented in story file.
   - [x] Story wrap-up section completed (notes, model, changelog).
6. Dependencies, Build & Configuration
   - [ ] Project builds successfully without errors (not run).
   - [ ] Project linting passes (no linter configured, not run).
   - [x] No new dependencies added.
   - [N/A] New dependencies recorded with justification.
   - [N/A] Security vulnerabilities review for new deps.
   - [N/A] New env vars/config documented.
7. Documentation
   - [N/A] Inline docs for new public APIs (no new public APIs).
   - [N/A] User-facing documentation updates required.
   - [N/A] Technical documentation updates required.

- [ ] I, the Developer Agent, confirm that all applicable items above have been addressed.

## QA Results

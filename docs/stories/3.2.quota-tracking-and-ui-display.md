# Quota Tracking and UI Display - Brownfield Addition

## User Story
As a user,
I want to see my weekly word quota and remaining words,
So that I understand my usage on the FREE plan.

## Status
Done

## Story Context

**Existing System Integration:**

- Integrates with: transcription pipeline output (post-process text), dashboard UI
- Technology: Electron (main/renderer), JS, optional Supabase sync
- Follows pattern: existing status updates and UI badges
- Touch points: transcription completion handler, UI render for account status

## Acceptance Criteria

**Functional Requirements:**

1. Weekly quota is defined as 2000 words with reset at Monday 00:00 UTC.
2. Word usage is counted from final text (post-process), not audio duration.
3. UI displays remaining words and next reset timestamp in the dashboard in a visible, consistent location.
4. UI remains stable when quota data is unavailable (shows a clear fallback).

**Integration Requirements:**
4. Existing dictation flow continues to work when quota is below limit.
5. Quota usage is stored in Supabase (per-user) without SQLite schema changes.
6. Integration with Supabase user identity is preserved (per-user quota).

**Quality Requirements:**
7. Change is covered by appropriate tests or manual verification steps.
8. Documentation is updated if needed (PRD/story refs).
9. No regression in existing functionality verified.

## Technical Notes

- **Integration Approach:** Increment weekly usage counter after each successful transcription; store and read from Supabase per-user record.
- **Existing Pattern Reference:** Current status messaging and user identity handling (Supabase user id/email).
- **Key Constraints:** Do not add new frameworks; keep logic in main/renderer JS.

## Definition of Done

- [x] Functional requirements met
- [x] Integration requirements verified
- [x] Existing functionality regression tested
- [x] Code follows existing patterns and standards
- [x] Tests pass (existing and new)
- [x] Documentation updated if applicable

## Risk and Compatibility Check

**Minimal Risk Assessment:**

- **Primary Risk:** Incorrect word count or reset window causing user confusion.
- **Mitigation:** Use a single helper for word counting and reset timestamp calculation.
- **Rollback:** Disable quota display while keeping counters intact.

**Compatibility Verification:**

- [x] No breaking changes to existing APIs
- [x] Database changes (if any) are additive only
- [x] UI changes follow existing design patterns
- [x] Performance impact is negligible

## Validation Checklist

**Scope Validation:**

- [x] Story can be completed in one development session
- [x] Integration approach is straightforward
- [x] Follows existing patterns exactly
- [x] No design or architecture work required

**Clarity Check:**

- [x] Story requirements are unambiguous
- [x] Integration points are clearly specified
- [x] Success criteria are testable
- [x] Rollback approach is simple

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-15 | v0.1 | Creation de la dev story | PM |
| 2026-01-18 | v0.2 | Quota tracking + dashboard display | Dev |

## Dev Agent Record
### Agent Model Used
GPT-5.2

### Debug Log References
N/A

### Completion Notes List
- Compteur de mots hebdo reset lundi 00:00 UTC (limite configurable), stocke cote Supabase (`quota_weekly_usage`) + cache local.
- Quota calcule depuis le texte final post-process, increment√© apres transcription reussie.
- Affichage dashboard: carte "Mots restants" + date de reset, fallback si non connecte.
- Note: actuellement l'app requiert l'auth; la distinction FREE/PRO sera basee sur l'abonnement Stripe actif des que l'integration Stripe est en place.

### File List
- main.js
- dashboard.html
- dashboard.js
- sync.js
- supabase/migrations/20260119_000001_quota_weekly_usage.sql
- supabase/functions/quota-snapshot/index.ts
- supabase/functions/quota-consume/index.ts
- docs/quota-server.md

## QA Results

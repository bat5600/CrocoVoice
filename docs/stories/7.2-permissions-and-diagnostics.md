# Epic 7 — Permissions and diagnostics (Windows-first)

## Status
InProgress

## Story
**As a** user,  
**I want** clear diagnostics when dictation or delivery fails (mic/permissions/paste/typing),  
**so that** I can understand what went wrong and fix it quickly.

## Acceptance Criteria
1. When dictation fails due to missing mic permission/device issues, the UI shows a clear reason and next action (retry / open settings).
2. When delivery fails (typing/paste/clipboard), the app explains why it likely failed and confirms the text is still available (clipboard fallback + toast).
3. A Diagnostics surface exists (screen/modal) that shows: permission statuses, last delivery mode used, and recent relevant errors/events.
4. Diagnostics includes Windows-first self-checks: microphone availability, hotkey registration status, clipboard write/read test, and last delivery attempt outcome.
5. Diagnostics can be copied/exported as text for support/debugging without exposing sensitive user content by default (redact transcripts; include counts/lengths only).
6. External web opens (billing portal, help links) show a clear loading indicator until the system browser is opened (or errors).
7. Diagnostics shows app version, OS version, and feature flag states.
8. Diagnostics UI never overflows horizontally; long lines wrap (preferred) and/or provide “Copy full” without breaking layout.

## Tasks / Subtasks
- [x] Add/standardize failure reasons for mic and delivery flows (AC: 1,2)
- [x] Implement Diagnostics UI surface and required data plumbing (AC: 3)
- [x] Add Windows-first self-checks and display them (AC: 4)
- [x] Implement safe “copy diagnostics” export (AC: 5)
- [x] Add loading indicators for external web opens (AC: 6)
- [x] Add app/OS/version and feature flag snapshot (AC: 7)
- [ ] Fix diagnostics summary layout for long lines (wrap + no overflow) and keep “copy diagnostics” usable (AC: 8)

## Dev Notes
- Delivery pipeline and fallback behavior is main-process-driven (`main.js`); emit structured failure reasons/events to the renderer for display.
- Keep diagnostics privacy-safe: avoid including full transcripts by default; include metadata and error codes/messages.
- UI: align to existing toast/status banner patterns in `dashboard.js` / `renderer.js`.
- Suggested diagnostics fields (v1):
  - App version + OS + locale
  - Last 20 events (timestamp + code + short message)
  - Microphone: device count + last getUserMedia error (if any)
  - Delivery: last mode attempted (type/paste/clipboard) + last failure reason + fallback used
  - Clipboard: write/read test results
  - Hotkey: configured shortcut + registration status

### Testing
- Manual: simulate permission denied, no mic device, paste failure, typing failure; verify diagnostics accuracy and clipboard fallback.
- UX: verify loading indicator for external web opens appears and clears reliably.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-20 | v0.1 | Story created from global PRD Epic 7 shard plan | PO |
| 2026-02-01 | v0.2 | Video review: diagnostics summary long-line overflow fix | PM |

## Dev Agent Record
### Agent Model Used
GPT-5 (Codex CLI)

### Debug Log References
- node test-core.js

### Completion Notes List
- Added diagnostics view with app/OS/flags, delivery status, events, and clipboard/mic checks.
- Recorded delivery/recording errors with privacy-safe events and clipboard fallback messaging.
- Added loading indicators for external portal/signup opens.

### File List
- main.js
- dashboard.html
- dashboard.js
- preload.js
- renderer.js

## QA Results

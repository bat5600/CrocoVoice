# Subscription Purchase and Portal Access - Brownfield Addition

## User Story
As a user,
I want to subscribe to PRO and manage my subscription,
So that I can access unlimited dictation and control billing.

## Story Context

**Existing System Integration:**

- Integrates with: Supabase auth + Stripe Checkout/Portal (web)
- Technology: Electron (main/renderer), JS, Supabase JS, Stripe
- Follows pattern: existing CTA buttons and status messaging
- Touch points: upgrade CTA, subscription status UI, user identity mapping

## Acceptance Criteria

**Functional Requirements:**

1. Upgrade CTA redirects the user to a web Stripe Checkout session for PRO.
2. Successful purchase immediately grants PRO access (unlimited dictation).
3. "Gerer mon abonnement" opens the Stripe customer portal on the web.

**Integration Requirements:**
4. Stripe customer is linked to the authenticated user (Supabase user id/email) and reused on future sessions.
5. Subscription status is displayed in the UI and persisted across restarts.
6. Login/signup/reset flows remain functional and unchanged.

**Quality Requirements:**
7. Change is covered by appropriate tests or manual verification steps.
8. Documentation is updated if needed (PRD/story refs).
9. No regression in existing functionality verified.

## Technical Notes

- **Integration Approach:** Redirect to web-hosted Stripe Checkout/Portal pages; never expose Stripe secret keys client-side.
- **Existing Pattern Reference:** Current UI CTA handling and Supabase session usage.
- **Key Constraints:** Stripe customer mapping must be deterministic for a given user.

## Definition of Done

- [ ] Functional requirements met
- [ ] Integration requirements verified
- [ ] Existing functionality regression tested
- [ ] Code follows existing patterns and standards
- [ ] Tests pass (existing and new)
- [ ] Documentation updated if applicable

## Risk and Compatibility Check

**Minimal Risk Assessment:**

- **Primary Risk:** Mismatch between Stripe subscription status and app access.
- **Mitigation:** Verify entitlement on startup and after checkout return.
- **Rollback:** Disable upgrade CTA and fall back to FREE-only access.

**Compatibility Verification:**

- [ ] No breaking changes to existing APIs
- [ ] Database changes (if any) are additive only
- [ ] UI changes follow existing design patterns
- [ ] Performance impact is negligible

## Validation Checklist

**Scope Validation:**

- [ ] Story can be completed in one development session
- [ ] Integration approach is straightforward
- [ ] Follows existing patterns exactly
- [ ] No design or architecture work required

**Clarity Check:**

- [ ] Story requirements are unambiguous
- [ ] Integration points are clearly specified
- [ ] Success criteria are testable
- [ ] Rollback approach is simple
